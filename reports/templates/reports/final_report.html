{% extends 'base.html' %}
{% load static %}

{% block title_head %}Final Report {{year}}{% endblock %}
{% block title %}Final Report {{year}}{% endblock %}

{% block extra_css%}
<link rel="stylesheet" href="{% static 'css/flags.css' %}">
{% endblock %}

{% block mainfull %}
<div class="columns">
  <div class="column is-half">
    <figure class="image">
      <svg id="globe" width="600" height="400"></svg>
      <img src="{% url 'partner-map' year %}" />
    </figure>
  </div>
  <div class="column is-half">
    <h2>Audience Size</h2>
      <table class="table">
      {% for k,v in demographics.items %}
      <tr>
        <th>{{k}}</th>
        <td>{{v}}</td>
      </tr>
      {% endfor %}
      <thead>
      <tr>
        <th>Total Individuals</th>
        <td>{{total.total}}</td>
      </tr>
      </thead>
    </table>
    <p class="has-text-grey">* - {{other_demos}}</p>
  </div>
</div>

<h2>Number of Partner Programs</h2>
<div class="columns">

  <div class="column is-one-quarter">
    <table class="table">
      <tr>
        <th>Countries with an active partner</th>
        <td>{{country_count}}</td>
      </tr>
      {% for region in regions %}
      <tr>
        <td>{{region.name}}</td>
        <td>{{region.number}}</td>
      </tr>
      {% endfor %}
      </table>
  </div>
  {% for title,data in partner_data.items %}
  <div class='column'>
    <h4>{{title|capfirst}}</h4>
    <table class="table">
    {% for row in data %}
    <tr>
      <th>{{row.name}}</th>
      <td>{{row.number}}<br/>{{row.percent}}%</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endfor %}
</div>
<p class="has-text-grey">Some partners serve multiple audience types and demographics.</p>

<div class="content">
{% for report in reports %}
  <h3>{{report.partner.name}}</h3>
    <div class="flags">
    {% for country in report.countries %}
    <i class="{{ country.flag_css }}" aria-label="{{ country.name }} flag"></i>
    {% endfor %}
    </div>
      <h4>Summary</h4>
      <p>{{report.summary}}</p>
      {% if report.imprint_set.all %}
      <h4>Impact Reports</h4>
      {% endif %}
      {% for impact in report.imprint_set.all %}
        <div class="flags">
        {% for country in impact.countries %}
        <i class="{{ country.flag_css }}"
        aria-label="{{ country.name }} flag"></i>
        {% endfor %}
        </div>
        <p>
          {{impact.impact}}
        </p>
      {% endfor %}
      <hr/>
      {% endfor %}
      </div>
{% endblock %}

{% block script-content %}
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<!-- Create an element where the map will take place -->

<script>

// The svg
var svg = d3.select("svg"),
  width = +svg.attr("width"),
  height = +svg.attr("height");

// Map and projection
var path = d3.geoPath();
var projection = d3.geoNaturalEarth()
    .scale(width / 1.5 / Math.PI)
    .translate([width / 2, height / 2])

// Data and color scale
var data = d3.map();
var colorScale = d3.scaleThreshold()
  .domain([1, 2, 5, 10, 50])
  .range(d3.schemeBlues[7]);

// Load external data and boot
d3.queue()
  .defer(d3.json,"{% static 'js/world.geo.json' %}")
  .defer(d3.csv, "", function(d) { data.set(d.code, +d.number);})
  .await(ready);

function ready(error, topo) {

  // Draw the map
  svg.append("g")
    .selectAll("path")
    .data(topo.features)
    .enter()
    .append("path")
      // draw each country
      .attr("d", d3.geoPath()
        .projection(projection)
      )
      // set the color of each country
      .attr("fill", function (d) {
        d.total = data.get(d.id) || 0;
        return colorScale(d.total);
      });

      // Download SVG of map
      // var svgData = $("#globe")[0].outerHTML;
      // var svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
      // var svgUrl = URL.createObjectURL(svgBlob);
      // var downloadLink = document.createElement("a");
      // downloadLink.href = svgUrl;
      // downloadLink.download = "choropleth.svg";
      // document.body.appendChild(downloadLink);
      // downloadLink.click();
      // document.body.removeChild(downloadLink);
}
</script>

{% endblock %}
